<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Campaigns Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#ffffff;
    --panel:#ffffff;
    --panel-2:#fafafa;
    --card:#ffffff;
    --ink:#111827;
    --muted:#6b7280;
    --accent:#ef4444;
    --accent-2:#dc2626;
    --accent-3:#fecaca;
    --ring: 0 0 0 2px rgba(239,68,68,.35), 0 10px 30px rgba(239,68,68,.15), inset 0 0 30px rgba(239,68,68,.05);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:
      radial-gradient(1000px 600px at 85% -20%, rgba(239,68,68,.07), transparent 55%),
      radial-gradient(900px 700px at -10% 110%, rgba(239,68,68,.08), transparent 60%),
      linear-gradient(180deg, #ffffff, #fafafa 30%, #f9fafb 100%);
    color:var(--ink);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }
  .shell{max-width:1100px;margin:0 auto;padding:28px clamp(16px,4vw,32px) 64px}
  .hero{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:28px}
  .title{
    font-weight:800;letter-spacing:.2px;line-height:1.05;font-size:clamp(24px,3vw,34px);
    background:linear-gradient(120deg,#7f1d1d 0%, #ef4444 45%, #fca5a5 70%, #7f1d1d 100%);
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 35px rgba(239,68,68,.15)
  }
  .subtitle{margin-top:6px;color:var(--muted);font-weight:400}
  .panel{
    background:linear-gradient(180deg,rgba(0,0,0,.01),rgba(0,0,0,0)) , var(--panel);
    border:1px solid rgba(239,68,68,.18);
    border-radius:18px;box-shadow:var(--ring);overflow:hidden
  }
  .panel header{padding:18px 20px;border-bottom:1px solid rgba(239,68,68,.18);background:linear-gradient(180deg, rgba(239,68,68,.08), transparent)}
  .panel header h2{margin:0;font-size:15px;font-weight:700;letter-spacing:.4px;color:#b91c1c;text-transform:uppercase}
  .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:16px}
  @media (max-width:980px){ .grid{grid-template-columns: 1fr}}
  .block{padding:16px}
  .card{background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,.03)) , var(--card);border:1px solid rgba(239,68,68,.16);border-radius:14px;padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{font-size:12px;color:#7f1d1d;letter-spacing:.2px;font-weight:600;text-transform:uppercase}
  input, select, button{
    font:inherit;color:var(--ink);background:#ffffff;border:1px solid rgba(239,68,68,.25);
    border-radius:12px;padding:12px 14px;outline:none;transition:.2s ease;min-width:0
  }
  input:focus,select:focus{box-shadow:0 0 0 2px rgba(239,68,68,.35)}
  .search{flex:1 1 260px;display:flex;gap:10px;align-items:center;background:#ffffff;border-radius:12px;border:1px solid rgba(239,68,68,.25);padding:8px 10px}
  .search input{flex:1;border:none;background:transparent;padding:6px 8px}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn{
    cursor:pointer;background:linear-gradient(180deg,var(--accent),var(--accent-2));
    color:#ffffff;border:none;font-weight:800;letter-spacing:.2px;
    padding:12px 16px;border-radius:12px;box-shadow:0 10px 30px rgba(239,68,68,.25), inset 0 -1px 0 rgba(0,0,0,.2)
  }
  .btn.secondary{background:linear-gradient(180deg,#ffffff,#f3f4f6);color:#1f2937;border:1px solid rgba(239,68,68,.35)}
  .btn.ghost{background:transparent;border:1px dashed rgba(239,68,68,.35);color:#b91c1c}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:640px){ .split{grid-template-columns:1fr}}
  .small{font-size:12px;color:var(--muted)}
  .stat{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px dashed rgba(239,68,68,.25);border-radius:12px;background:#ffffff}
  .count{font-weight:800;color:#b91c1c}
  select{width:100%}
  .list{max-height:320px;overflow:auto;border:1px solid rgba(239,68,68,.2);border-radius:12px;background:#ffffff}
  .list option{padding:8px}
  .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  #analysis{min-height:260px;white-space:pre-wrap;border-radius:14px;padding:16px;background:#ffffff;border:1px solid rgba(239,68,68,.2);line-height:1.45}
  .footer-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
  .status{padding:10px 12px;border-radius:10px;background:#ffffff;border:1px solid rgba(239,68,68,.25);color:#374151}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.35);color:#991b1b;font-size:12px;font-weight:700}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
  @media (max-width:900px){.kpi{grid-template-columns:repeat(2,1fr)}}
  .kpi .card{padding:12px}
  .kpi .card h3{margin:0 0 2px 0;font-size:12px;color:#6b7280;text-transform:uppercase;letter-spacing:.3px}
  .kpi .card div{font-weight:800;font-size:18px;color:#111827}
  #progressBar{height:6px;border-radius:999px;background:rgba(239,68,68,.15);overflow:hidden;display:none;margin-top:8px}
  #progressInner{height:100%;width:20%;background:linear-gradient(90deg,#fecaca,#ef4444);animation:p 1.2s infinite linear}
  @keyframes p { from{transform:translateX(-100%)} to{transform:translateX(300%)} }
</style>
</head>
<body>
  <div class="shell">
    <div class="hero">
      <div>
        <div class="title">Hey EBP Team,</div>
        <div class="subtitle">Live campaign directory with analysis on demand</div>
      </div>
      <div class="pill" id="statusPill">Idle</div>
    </div>

    <section class="panel">
      <header><h2>Campaign Directory</h2></header>
      <div class="block">
        <div class="grid">
          <div class="card">
            <div class="row" style="margin-bottom:10px">
              <label>Search</label>
              <div class="search" style="width:100%">
                <input id="searchInput" type="text" placeholder="Filter by ID or name…" autocomplete="off" />
                <button class="btn secondary" id="loadBtn">Load Campaigns</button>
              </div>
            </div>
            <div class="split" style="margin-bottom:10px">
              <div class="stat"><span class="small">Loaded</span> <span class="count" id="loadedCount">0</span> <span class="small">campaigns</span></div>
              <div class="stat"><span class="small">Filtered</span> <span class="count" id="filteredCount">0</span></div>
            </div>
            <select id="campaignList" class="list" size="12"></select>
            <div class="split" style="margin-top:10px">
              <div>
                <label>Manual Campaign ID</label>
                <input id="manualId" type="text" placeholder="Paste a Campaign ID" class="mono" />
              </div>
              <div>
                <label>Selected Campaign</label>
                <input id="selectedId" type="text" class="mono" readonly />
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Date Preset</label>
              <select id="datePreset">
                <option value="today">today</option>
                <option value="yesterday">yesterday</option>
                <option value="this_month">this_month</option>
                <option value="last_month">last_month</option>
                <option value="this_quarter">this_quarter</option>
                <option value="maximum">maximum</option>
                <option value="data_maximum">data_maximum</option>
                <option value="last_3d">last_3d</option>
                <option value="last_7d" selected>last_7d</option>
                <option value="last_14d">last_14d</option>
                <option value="last_28d">last_28d</option>
                <option value="last_30d">last_30d</option>
                <option value="last_90d">last_90d</option>
                <option value="last_week_mon_sun">last_week_mon_sun</option>
                <option value="last_week_sun_sat">last_week_sun_sat</option>
                <option value="last_quarter">last_quarter</option>
                <option value="last_year">last_year</option>
                <option value="this_week_mon_today">this_week_mon_today</option>
                <option value="this_week_sun_today">this_week_sun_today</option>
                <option value="this_year">this_year</option>
              </select>
            </div>

            <div class="actions" style="margin-top:12px">
              <button class="btn" id="analyzeBtn">Analyze</button>
              <button class="btn ghost" id="copyIdBtn">Copy ID</button>
              <button class="btn ghost" id="downloadBtn">Download HTML</button>
            </div>
          </div>

          <div class="card">
            <div class="kpi">
              <div class="card"><h3>Directory</h3><div id="kpiDir">–</div></div>
              <div class="card"><h3>Platform</h3><div id="kpiPlat">Meta</div></div>
              <div class="card"><h3>Mode</h3><div id="kpiMode">Listing + Analysis</div></div>
              <div class="card"><h3>Status</h3><div id="kpiStatus">Idle</div></div>
            </div>

            <div id="progressBar"><div id="progressInner"></div></div>

            <div style="margin-top:14px">
              <label>Analysis Output</label>
              <div id="analysis" class="mono"></div>
              <div class="footer-actions">
                <button class="btn secondary" id="copyAnalysisBtn">Copy Analysis</button>
                <button class="btn ghost" id="clearAnalysisBtn">Clear</button>
              </div>
            </div>
            <div style="margin-top:10px" class="small" id="debugArea"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
(function(){
  // Endpoints (as per your spec)
  const LIST_URL   = 'https://ebp.app.n8n.cloud/webhook/3248c413-9c98-46a0-b241-3a38ccb1651b';
  const START_URL  = 'https://ebp.app.n8n.cloud/webhook/e2ee0fb9-7d68-4e58-9749-e78cccff3f9f'; // returns { jobid: "xxxxxx" }
  const STATUS_URL = 'https://ebp.app.n8n.cloud/webhook/ae5a5bfb-46b8-4fac-b04c-b6bc36ea5c01';  // poll with ?jobid=xxxxxx

  // UI refs
  const statusPill = document.getElementById('statusPill');
  const kpiDir = document.getElementById('kpiDir');
  const kpiStatus = document.getElementById('kpiStatus');
  const loadedCount = document.getElementById('loadedCount');
  const filteredCount = document.getElementById('filteredCount');
  const searchInput = document.getElementById('searchInput');
  const list = document.getElementById('campaignList');
  const selectedId = document.getElementById('selectedId');
  const manualId = document.getElementById('manualId');
  const analysisBox = document.getElementById('analysis');
  const debugArea = document.getElementById('debugArea');
  const loadBtn = document.getElementById('loadBtn');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const copyIdBtn = document.getElementById('copyIdBtn');
  const copyAnalysisBtn = document.getElementById('copyAnalysisBtn');
  const clearAnalysisBtn = document.getElementById('clearAnalysisBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const datePreset = document.getElementById('datePreset');
  const progressBar = document.getElementById('progressBar');

  // State
  let campaignsParsed = [];
  let filtered = [];
  let pollTimer = null;
  let twoMinuteTimer = null;
  let lastJobId = null;

  function setStatus(text){ statusPill.textContent = text; kpiStatus.textContent = text; }
  function setDirectoryKpi(n){ kpiDir.textContent = n > 0 ? `${n} loaded` : '–'; }
  function showProgress(show){ progressBar.style.display = show ? 'block' : 'none'; }

  // Robust fetch with 30s client timeout
  async function fetchJson(url, options={}){
    const controller = new AbortController();
    const to = setTimeout(()=>controller.abort(), 30000);
    try{
      const res = await fetch(url, {mode:'cors', credentials:'omit', cache:'no-store', signal:controller.signal, ...options});
      const txt = await res.text();
      let data; try{ data = JSON.parse(txt); }catch{ data = txt; }
      return { ok: res.ok, status: res.status, data, raw: txt };
    }catch(err){
      return { ok:false, status:0, data:null, raw:String(err && err.message || err) };
    }finally{ clearTimeout(to); }
  }

  function parseCampaignLine(line){
    if (typeof line !== 'string') return null;
    const clean = line.replace(/\r/g,'').trim();
    const idx = clean.indexOf(' - ');
    if (idx === -1) return { id: clean.trim(), name: '' };
    const id = clean.slice(0, idx).trim();
    const name = clean.slice(idx + 3).replace(/\s+/g,' ').trim();
    return { id, name };
  }

  function renderList(items){
    list.innerHTML = '';
    for (const c of items){
      const o = document.createElement('option');
      o.value = c.id;
      o.textContent = `${c.id} — ${c.name || ''}`.trim();
      list.appendChild(o);
    }
    filtered = items;
    filteredCount.textContent = String(items.length);
  }

  function applyFilter(){
    const q = (searchInput.value||'').trim().toLowerCase();
    if (!q){ renderList(campaignsParsed); return; }
    const out = campaignsParsed.filter(c =>
      c.id.toLowerCase().includes(q) || (c.name||'').toLowerCase().includes(q)
    );
    renderList(out);
  }

  async function loadCampaigns(){
    setStatus('Loading campaigns'); debugArea.textContent='';
    const res = await fetchJson(LIST_URL, { method:'GET' });
    if (!res.ok){
      setStatus('List failed'); debugArea.textContent = `Listing error [${res.status}]: ${res.raw}`;
      campaignsParsed=[]; loadedCount.textContent='0'; filteredCount.textContent='0';
      renderList([]); setDirectoryKpi(0); return;
    }
    let payload = res.data;
    if (typeof payload === 'string'){ try{ payload = JSON.parse(payload); }catch{} }
    const root = Array.isArray(payload) ? payload[0] : payload;
    const arr = (root && (root['all campaigns'] || root['all_campaigns'] || root['campaigns'])) || [];
    const unique = new Map();
    for (const item of arr){
      const parsed = parseCampaignLine(item);
      if (parsed && parsed.id) unique.set(parsed.id, parsed);
    }
    campaignsParsed = Array.from(unique.values());
    loadedCount.textContent = String(campaignsParsed.length);
    setDirectoryKpi(campaignsParsed.length);
    renderList(campaignsParsed);
    setStatus('Ready');
  }

  function clearTimers(){
    if (pollTimer){ clearTimeout(pollTimer); pollTimer=null; }
    if (twoMinuteTimer){ clearTimeout(twoMinuteTimer); twoMinuteTimer=null; }
  }

  async function startAnalysis(campaignId, preset){
    // Start job → expect { jobid: "xxxxxx" }
    const body = JSON.stringify({ campaign_id: campaignId, date_preset: preset });
    const res = await fetchJson(START_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body });
    if (!res.ok){ throw new Error(`Start failed [${res.status}] ${res.raw}`); }
    let data = res.data;
    if (typeof data === 'string'){ try{ data = JSON.parse(data); }catch{} }
    const jobid = (data && (data.jobid || data.jobId || data.JOBID)) ? (data.jobid || data.jobId || data.JOBID) : null;
    if (!jobid) throw new Error(`No jobid in response: ${res.raw}`);
    // Persist for safety
    lastJobId = String(jobid);
    try{ localStorage.setItem('lastJobId', lastJobId); }catch{}
    return lastJobId;
  }

  async function pollStatus(jobid){
    const url = `${STATUS_URL}?jobid=${encodeURIComponent(jobid)}`;
    const res = await fetchJson(url, { method:'GET' });
    if (!res.ok){ throw new Error(`Status failed [${res.status}] ${res.raw}`); }
    let data = res.data;
    if (typeof data === 'string'){ try{ data = JSON.parse(data); }catch{} }
    // Expect: { status: "pending" } OR { status: "<the analysis text>" }
    if (!data || typeof data !== 'object' || !('status' in data)){
      // In case backend returns raw analysis string
      if (typeof data === 'string' && data.trim()){
        return { pending:false, text: data.trim() };
      }
      throw new Error(`Malformed status payload: ${res.raw}`);
    }
    if (String(data.status).toLowerCase() === 'pending'){
      return { pending:true, text:'' };
    }
    return { pending:false, text: String(data.status || '').trim() };
  }

  function scheduleNextPoll(jobid){
    pollTimer = setTimeout(async ()=>{
      try {
        const r = await pollStatus(jobid);
        if (r.pending){
          setStatus('Waiting (poll)…');
          scheduleNextPoll(jobid); // keep going every 20s until ready
        } else {
          analysisBox.textContent = r.text || '';
          setStatus('Done');
          showProgress(false);
          clearTimers();
        }
      } catch (err){
        debugArea.textContent = `Poll error: ${String(err.message||err)}`;
        setStatus('Analysis failed (poll)');
        showProgress(false);
        // keep retrying despite transient errors
        scheduleNextPoll(jobid);
      }
    }, 20000); // 20 seconds between polls (as requested)
  }

  async function analyzeFlow(){
    clearTimers();
    analysisBox.textContent = '';
    debugArea.textContent = '';
    showProgress(true);

    const id = (selectedId.value || '').trim() || (manualId.value || '').trim();
    if (!id){ setStatus('No ID'); showProgress(false); return; }
    const preset = datePreset ? datePreset.value : 'last_7d';

    try{
      setStatus('Starting…');
      const jobid = await startAnalysis(id, preset);
      setStatus(`Job queued (${jobid}) — waiting 2 min…`);

      twoMinuteTimer = setTimeout(async ()=>{
        try{
          setStatus('Checking status…');
          const r = await pollStatus(jobid);
          if (r.pending){
            setStatus('Waiting (poll)…');
            scheduleNextPoll(jobid); // start 20s polling loop
          } else {
            analysisBox.textContent = r.text || '';
            setStatus('Done');
            showProgress(false);
          }
        }catch(err){
          debugArea.textContent = `First check error: ${String(err.message||err)}`;
          setStatus('Analysis failed (first check)');
          // still begin polling loop to recover
          scheduleNextPoll(jobid);
        }
      }, 120000); // 2 minutes before first status check

    }catch(err){
      setStatus('Start failed');
      showProgress(false);
      debugArea.textContent = String(err && err.message || err);
    }
  }

  // Wire up events
  list.addEventListener('change', ()=>{ selectedId.value = list.value || ''; });
  searchInput.addEventListener('input', ()=>{
    window.clearTimeout(searchInput._t);
    searchInput._t = setTimeout(applyFilter, 120); // 120 ms
  });
  loadBtn.addEventListener('click', loadCampaigns);
  analyzeBtn.addEventListener('click', analyzeFlow);
  copyIdBtn.addEventListener('click', async ()=>{
    const id = selectedId.value || manualId.value || '';
    if (!id){ setStatus('No ID'); return; }
    try{ await navigator.clipboard.writeText(id); setStatus('ID copied'); }catch{ setStatus('Copy failed'); }
  });
  clearAnalysisBtn.addEventListener('click', ()=>{ analysisBox.textContent=''; debugArea.textContent=''; setStatus('Cleared'); });
  copyAnalysisBtn.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(analysisBox.textContent || ''); setStatus('Analysis copied'); }catch{ setStatus('Copy failed'); }
  });
  downloadBtn.addEventListener('click', ()=>{
    const blob = new Blob([document.documentElement.outerHTML], {type:'text/html;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'campaigns_analysis_tool.html';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    setStatus('Downloaded');
  });

  // Boot
  loadCampaigns();
})();
</script>
</body>
</html>
